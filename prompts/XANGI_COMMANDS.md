# XANGI_COMMANDS.md - xangi専用ガイド

xangiの専用コマンド・設定・運用ルール。
**セッション開始時に必ず読むこと。**

## Discord操作コマンド

**⚠️ `!discord` コマンドはBashコマンドではない！**
応答テキストに直接書くこと。Bashツールで実行すると `command not found` エラーになる。
xangiがテキスト出力を各行ごとにパースして処理する仕組み。

**📏 記述ルール（全コマンド共通）：**
- **行頭に書くこと** — 各行をtrimしてから `startsWith` でチェックされるため、行の途中に書いても認識されない
- **コードブロック内は無視される** — ` ``` ` で囲んだ中のコマンドは実行されない（ドキュメント例示に安全に使える）
- `!discord`, `!schedule`, `SYSTEM_COMMAND:` はすべて行頭必須
- `MEDIA:` だけは例外で、行の途中でも認識される

### 別チャンネルにメッセージ送信

```
!discord send <#チャンネルID> メッセージ内容
```

**例：**
```
!discord send <#1469606785672417383> hello!
!discord send <#1466570723639165072> 作業開始します
```

**注意：**
- `<#チャンネルID>` の形式を守ること（`<#` と `>` で囲む）
- 「〇〇チャンネルに△△って言って」と頼まれたら、このコマンドを使う

### チャンネル一覧を取得

```
!discord channels
```

### チャンネル履歴の取得

```
!discord history [件数] [<#チャンネルID>]
```

チャンネルの最新メッセージを取得する。**結果はDiscordに送信されず、自分のコンテキストに返る。**

- 件数省略時はデフォルト10件、最大100件
- チャンネルID省略時は現在のチャンネル
- `offset:N` で古いメッセージに遡れる（30件ずつ取得でタイムアウト防止）

**例：**
```
!discord history              # 現在のチャンネル最新10件
!discord history 50           # 現在のチャンネル最新50件
!discord history 20 <#1466570723639165072>  # 指定チャンネル20件
!discord history 30 offset:30   # 30〜60件目を取得
!discord history 30 offset:60   # 60〜90件目を取得
!discord history 30 offset:30 <#1466570723639165072>  # 別チャンネルで遡る
```

**大量の履歴を取得したい場合（タイムアウト防止）：**
100件一括取得ではなく、30件ずつoffsetで遡ること：
1. `!discord history 30` → 最新30件
2. `!discord history 30 offset:30` → 30〜60件目
3. `!discord history 30 offset:60` → 60〜90件目

**用途：**
- セッションリセット後に会話の文脈を把握
- 過去の会話を参照して判断材料にする
- 日記作成時に1日分の会話を段階的に取得

### メッセージ検索

```
!discord search キーワード
```

現在のチャンネルでキーワードを含むメッセージを検索する。**結果はDiscordに送信されず、自分のコンテキストに返る。**

### メッセージ削除

```
!discord delete <メッセージID>      # 指定メッセージを削除
!discord delete <メッセージリンク>   # リンク先メッセージを削除（別チャンネルも可）
```

- 必ずメッセージIDまたはリンクを指定すること（引数なしは不可）
- 自分（bot）のメッセージのみ削除可能（他人のメッセージは削除できない）
- メッセージリンクは `https://discord.com/channels/...` 形式

**⚠️ 重要：ユーザーがメッセージリンクを貼った場合の削除手順：**
1. `!discord history` は**実行しない**（不要）
2. ユーザーが貼ったリンクをそのまま `!discord delete <リンク>` に渡す
3. 例: ユーザーが `https://discord.com/channels/111/222/333` を貼って「消して」→ `!discord delete https://discord.com/channels/111/222/333`

リンクもIDも不明で「さっきの消して」のような場合のみ、履歴でIDを確認する。

---

## ファイル送信

チャットにファイルを送信する場合は、出力に以下の形式でパスを含める（**行頭でなくてもOK**、テキスト途中でも認識される）：

```
MEDIA:/path/to/file
```

**対応形式:** png, jpg, jpeg, gif, webp, mp3, mp4, wav, flac, pdf, zip

**例：**
```
画像を生成しました。
MEDIA:/tmp/output.png
```

ユーザーが添付したファイルは `[添付ファイル]` としてパスが渡される。
添付ファイルの保存先: `[STATE_DIR]/media/attachments/`

---

## システムコマンド

応答に以下の形式を含めることで、システムを操作できる（行頭に記述）：

- `SYSTEM_COMMAND:restart` — ボットを再起動
- `SYSTEM_COMMAND:set autoRestart=true` — 自動再起動を有効化
- `SYSTEM_COMMAND:set autoRestart=false` — 自動再起動を無効化

ユーザーから再起動を求められた場合は `SYSTEM_COMMAND:restart` を含める。
スラッシュコマンド `/restart` `/settings` もある。


## スケジュール・リマインダー

`!schedule` コマンドでリマインダーや定期実行を設定できる。

### 設定ファイル

`.xangi/schedules.json` に保存される。手動で編集も可能。

### コマンド

```
!schedule add <設定>     # スケジュール追加
!schedule list           # 一覧表示
!schedule remove <ID>    # 削除
!schedule toggle <ID>    # 有効/無効切り替え
```

### 設定フォーマット

- `30分後 ミーティング` — N分後（秒/時間も可）
- `15:00 レビュー` — 今日のその時刻（過ぎたら翌日）
- `2025-03-01 14:00 締め切り` — 日時指定
- `毎日 9:00 おはよう` — 毎日定時
- `毎時 チェック` — 毎時0分
- `毎週月曜 10:00 週次MTG` — 毎週（月〜日対応）
- `cron 0 9 * * * おはよう` — cron式直接指定

### 別チャンネルへの送信

`-c <#チャンネルID>` または `<#チャンネルID>` を先頭に付けると、指定チャンネルに送信できる。

```
!schedule add -c <#1469606785672417383> 3分後 テストメッセージ
!schedule add <#1469606785672417383> 毎日 9:00 おはよう
```

## 自動展開機能（読み取り専用）

これらは xangi が自動で処理するので、コマンド不要：

- `https://discord.com/channels/.../...` リンク → リンク先メッセージの内容を展開
- `<#channelId>` または `#channel名` → そのチャンネルの最新10件を展開


## タイムアウト対策

xangiのデフォルトタイムアウトは5分（300000ms）。
5分以上かかる処理はバックグラウンド実行し、即座に「実行開始した」と応答を返すこと。

### `nohup` vs `run_in_background` の使い分け

- **`nohup コマンド > log 2>&1 &`（推奨）** — Claude Codeプロセスが終了しても処理が継続する。タイムアウトやセッション切れでも安全
- **`run_in_background: true`** — Claude Codeプロセス内で動くため、タイムアウト（5分）でプロセスごとkillされると一緒に死ぬ

**結論：長時間処理は `nohup` を使うこと。** `run_in_background` はプロセスが生きている間だけの短いバックグラウンド処理向け。

```bash
# 長時間処理の例
nohup 長いコマンド > /tmp/output.log 2>&1 &
echo "PID: $!"
```

結果は次回のやり取り時に `tail /tmp/output.log` で確認して報告する。

### 必ずバックグラウンド実行する処理
- 文字起こし
- 大規模ビルド
- 長時間のダウンロード
